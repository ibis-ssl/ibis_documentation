# crane_session_controller

## æ¦‚è¦

**crane_session_controller**ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã€Crane SSLãƒ­ãƒœãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã®**æœ€ä¸Šä½åˆ¶å¾¡ãƒ¬ã‚¤ãƒ¤ãƒ¼**ã¨ã—ã¦ã€åŒ…æ‹¬çš„ãªè©¦åˆç®¡ç†ã¨ã‚²ãƒ¼ãƒ çŠ¶æ…‹åˆ¶å¾¡ã‚’æä¾›ã—ã¾ã™ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒœãƒƒãƒˆå½¹å‰²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã€å‹•çš„ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†ã¨YAMLé§†å‹•è¨­å®šã‚’é€šã˜ã¦SSLè©¦åˆä¸­ã®è¤‡æ•°ãƒ­ãƒœãƒƒãƒˆã‚’å”èª¿åˆ¶å¾¡ã—ã¾ã™ã€‚æŸ”è»Ÿã§è¨­å®šé§†å‹•ãªãƒ­ãƒœãƒƒãƒˆå½¹å‰²ç®¡ç†ã«ã‚ˆã‚Šã€SSLè©¦åˆã§ã®æ´—ç·´ã•ã‚ŒãŸãƒãƒ«ãƒãƒ­ãƒœãƒƒãƒˆå”èª¿ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## ä¸»è¦æ©Ÿèƒ½

- **è©¦åˆçµ±æ‹¬åˆ¶å¾¡**: SSLè©¦åˆå…¨ä½“ã®ãƒ•ãƒ­ãƒ¼ç®¡ç†
- **ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†**: çŠ¶æ³ã«å¿œã˜ãŸæˆ¦ç•¥ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®é¸æŠãƒ»åˆ‡ã‚Šæ›¿ãˆ
- **ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†**: Refereeä¿¡å·ã«åŸºã¥ãçŠ¶æ…‹é·ç§»åˆ¶å¾¡
- **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†**: è©¦åˆçŠ¶æ³ã®å±¥æ­´ãƒ»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¿æŒ
- **YAMLè¨­å®šé§†å‹•**: æŸ”è»ŸãªçŠ¶æ³å¯¾å¿œè¨­å®š

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸Šã®å½¹å‰²

Craneã‚·ã‚¹ãƒ†ãƒ ã®**æœ€ä¸Šä½åˆ¶å¾¡å±¤**ã¨ã—ã¦ã€SSL Refereeã‹ã‚‰ã®æŒ‡ç¤ºã‚’è§£é‡ˆã—ã€é©åˆ‡ãªæˆ¦ç•¥ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã‚’é¸æŠãƒ»å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€è©¦åˆå…¨ä½“ã‚’çµ±æ‹¬ã—ã¾ã™ã€‚ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚Šã€æ§˜ã€…ãªæˆ¦è¡“ã‚’çŠ¶æ³ã«å¿œã˜ã¦å‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

### SessionControllerï¼ˆãƒ¡ã‚¤ãƒ³åˆ¶å¾¡ï¼‰

- **çŠ¶æ…‹ç®¡ç†**: SSL RefereeçŠ¶æ…‹ã®è¿½è·¡ã¨å¯¾å¿œ
- **ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼é¸æŠ**: çŠ¶æ³ã«å¿œã˜ãŸæœ€é©ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®é¸æŠ
- **å®Ÿè¡Œåˆ¶å¾¡**: é¸æŠã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®å®Ÿè¡Œç®¡ç†
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ç•°å¸¸çŠ¶æ³ã§ã®å®‰å…¨ãªå‹•ä½œ

## çŠ¶æ³å¯¾å¿œè¨­å®šï¼ˆYAMLé§†å‹•ï¼‰

### åŸºæœ¬è©¦åˆçŠ¶æ³

- **HALT.yaml**: è©¦åˆåœæ­¢æ™‚ã®å‹•ä½œ
- **STOP.yaml**: ä¸€æ™‚åœæ­¢æ™‚ã®å‹•ä½œ
- **INPLAY.yaml**: é€šå¸¸ãƒ—ãƒ¬ã‚¤æ™‚ã®å‹•ä½œ
- **PRE_KICK_OFF.yaml**: ã‚­ãƒƒã‚¯ã‚ªãƒ•æº–å‚™

### ç‰¹æ®ŠçŠ¶æ³

- **OUR_KICKOFF_START.yaml**: è‡ªãƒãƒ¼ãƒ ã‚­ãƒƒã‚¯ã‚ªãƒ•
- **OUR_FREE_KICK.yaml**: è‡ªãƒãƒ¼ãƒ ãƒ•ãƒªãƒ¼ã‚­ãƒƒã‚¯
- **OUR_PENALTY_KICK.yaml**: è‡ªãƒãƒ¼ãƒ ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚­ãƒƒã‚¯
- **OUR_BALL_PLACEMENT.yaml**: è‡ªãƒãƒ¼ãƒ ãƒœãƒ¼ãƒ«é…ç½®

### æ•µãƒãƒ¼ãƒ çŠ¶æ³

- **THEIR_FREE_KICK.yaml**: æ•µãƒãƒ¼ãƒ ãƒ•ãƒªãƒ¼ã‚­ãƒƒã‚¯
- **THEIR_PENALTY_KICK.yaml**: æ•µãƒãƒ¼ãƒ ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚­ãƒƒã‚¯
- **THEIR_BALL_PLACEMENT.yaml**: æ•µãƒãƒ¼ãƒ ãƒœãƒ¼ãƒ«é…ç½®

### æˆ¦è¡“ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

- **formation.yaml**: åŸºæœ¬ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- **ibis_formation.yaml**: ibisç‰¹åˆ¥ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- **wing_formation.yaml**: ã‚¦ã‚¤ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- **sandwich.yaml**: ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒæˆ¦è¡“

## å‹•ä½œãƒ•ãƒ­ãƒ¼

### çŠ¶æ³åˆ¤å®šâ†’ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼é¸æŠ

```cpp
void SessionController::update() {
  // 1. ç¾åœ¨çŠ¶æ³ã®åˆ†æ
  auto situation = analyzeCurrent Situation();

  // 2. é©åˆ‡ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®é¸æŠ
  auto config = loadSituationConfig(situation);

  // 3. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®é¸æŠãƒ»åˆ‡ã‚Šæ›¿ãˆ
  auto planner = selectOptimalPlanner(config);

  // 4. ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®å®Ÿè¡Œ
  planner->plan(context_);

  // 5. çµæœã®çµ±åˆãƒ»é…ä¿¡
  publishRobotCommands();
}
```

### YAMLè¨­å®šä¾‹

```yaml
# OUR_FREE_KICK.yaml
situation: "OUR_FREE_KICK"
priority: "high"

robots:
  - id: 0
    role: "kicker"
    planner: "FreekickKickerPlanner"
  - id: 1
    role: "receiver"
    planner: "FreekickReceiverPlanner"
  - id: 2-5
    role: "supporter"
    planner: "FormationPlanner"

constraints:
  ball_distance: 0.5  # SSLè¦å®šè·é›¢
  formation_type: "freekick_support"
  timeout: 10.0       # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“
```

## ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ç®¡ç†

```cpp
class SessionController {
private:
  std::map<std::string, std::shared_ptr<PlannerBase>> planners_;
  std::string current_planner_name_;

public:
  void switchPlanner(const std::string& planner_name) {
    if (planners_.count(planner_name)) {
      current_planner_ = planners_[planner_name];
      current_planner_->reset();
    }
  }
};
```

### å‹•çš„ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼é¸æŠ

```cpp
std::string selectOptimalPlanner(const GameSituation& situation) {
  if (situation.is_freekick) {
    return situation.our_freekick ? "FreekickOffensePlanner" : "FreekickDefensePlanner";
  } else if (situation.is_penalty) {
    return situation.our_penalty ? "PenaltyOffensePlanner" : "PenaltyDefensePlanner";
  } else {
    return "InplayPlanner";
  }
}
```

## ä¾å­˜é–¢ä¿‚

### ã‚³ã‚¢ä¾å­˜

- **crane_planner_plugins**: å®Ÿéš›ã®æˆ¦ç•¥ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ç¾¤
- **crane_msg_wrappers**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›ãƒ»çµ±åˆ
- **crane_msgs**: ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šç¾©

### æ©Ÿèƒ½ä¾å­˜

- **yaml-cpp**: YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
- **diagnostic_updater**: ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­
- **closest_point_vendor**: å¹¾ä½•å­¦è¨ˆç®—æ”¯æ´

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬èµ·å‹•

```bash
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼èµ·å‹•
ros2 run crane_session_controller crane_session_controller_node

# ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“èµ·å‹•ï¼ˆå«ã‚€ï¼‰
ros2 launch crane_bringup crane.launch.xml
```

### ã‚«ã‚¹ã‚¿ãƒ è¨­å®š

```yaml
# config/custom_situation.yaml
situation: "CUSTOM_DEFENSE"
robots:
  - id: 0
    role: "goalie"
    planner: "GoaliePlanner"
  - id: [1,2,3]
    role: "defender"
    planner: "DefensePlanner"
```

## æœ€è¿‘ã®é–‹ç™ºçŠ¶æ³

### 2024å¹´ã®ä¸»è¦å¤‰æ›´

- **YAMLè¨­å®šæ‹¡å……**: ã‚ˆã‚ŠæŸ”è»ŸãªçŠ¶æ³å¯¾å¿œè¨­å®šã®è¿½åŠ 
- **ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼çµ±åˆæ”¹è‰¯**: æ–°ã—ã„ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã®çµ±åˆå¼·åŒ–
- **çŠ¶æ³åˆ¤å®šç²¾åº¦å‘ä¸Š**: ã‚ˆã‚Šæ­£ç¢ºãªè©¦åˆçŠ¶æ³ã®èªè­˜
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**: çŠ¶æ…‹é·ç§»ã®é«˜é€ŸåŒ–

### é–‹ç™ºæ´»ç™ºåº¦

ğŸŸ¡ **ä¸­æ´»å‹•**: ã‚·ã‚¹ãƒ†ãƒ ã®æœ€ä¸Šä½åˆ¶å¾¡ã¨ã—ã¦ã€æ–°ã—ã„æˆ¦è¡“å¯¾å¿œã‚„è©¦åˆè¦å‰‡å¤‰æ›´ã¸ã®å¯¾å¿œãŒå®šæœŸçš„ã«è¡Œã‚ã‚Œã¦ã„ã‚‹ã€‚ç‰¹ã«YAMLè¨­å®šã‚·ã‚¹ãƒ†ãƒ ã®æ‹¡å……ã¨ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼çµ±åˆæ©Ÿèƒ½ã®æ”¹è‰¯ãŒæ´»ç™ºã€‚

### æŠ€è¡“çš„ç‰¹å¾´

- **è¨­å®šé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—ã§ã®æˆ¦è¡“èª¿æ•´
- **ãƒ—ãƒ©ã‚°ã‚¤ãƒ³çµ±åˆ**: å‹•çš„ãªãƒ—ãƒ©ãƒ³ãƒŠãƒ¼é¸æŠãƒ»åˆ‡ã‚Šæ›¿ãˆ
- **çŠ¶æ³é©å¿œ**: SSLè¦å‰‡å¤‰æ›´ã¸ã®æŸ”è»Ÿãªå¯¾å¿œ

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### å¿œç­”æ€§èƒ½

- **çŠ¶æ³åˆ¤å®šæ™‚é–“**: <5ms
- **ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼åˆ‡ã‚Šæ›¿ãˆ**: <10ms
- **å…¨ä½“åˆ¶å¾¡å‘¨æœŸ**: 60Hzå¯¾å¿œ

### ç®¡ç†å®¹é‡

- **åŒæ™‚ç®¡ç†ãƒ­ãƒœãƒƒãƒˆ**: æœ€å¤§11å°
- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: 25ç¨®é¡ã®çŠ¶æ³å¯¾å¿œ
- **ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ç¨®é¡**: 20ç¨®é¡ä»¥ä¸Š

## å°†æ¥å±•æœ›

### æŠ€è¡“ç™ºå±•

- **AIçµ±åˆ**: æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹çŠ¶æ³åˆ¤å®šã®é«˜åº¦åŒ–
- **é©å¿œåˆ¶å¾¡**: å¯¾æˆ¦ç›¸æ‰‹ã«å¿œã˜ãŸå‹•çš„æˆ¦è¡“èª¿æ•´
- **äºˆæ¸¬åˆ¶å¾¡**: ã‚ˆã‚Šé•·æœŸçš„ãªæˆ¦ç•¥è¨ˆç”»

---

**é–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**: [crane_planner_plugins](./crane_planner_plugins.md) | [crane_play_switcher](./crane_play_switcher.md) | [crane_robot_skills](./crane_robot_skills.md)
